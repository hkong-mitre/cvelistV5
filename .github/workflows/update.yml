# Github Action for updates to the repository

name: CVE Update

on:
  # run every 5 minutes (min Github scheduling allowed)
  # note this may not complete when the hourly "CVE Release" workflow starts, so that this update may not be reflected
  #   in the CVE Release artifacts
  # note also that if this job runs longer than 5 minutes, the next job will run 5 minutes after this completes
  schedule:
    - cron: '*/5 * * * *'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: false
        default: 'debug'
jobs:
  update-cves:
    environment: development
    runs-on: ubuntu-latest
    env:
      CVE_SERVICES_URL: https://cveawg.mitre.org/api/cve
      CVES_BASE_DIRECTORY: ./preview_cves
      CVE_API_ORG: ${{secrets.CVE_API_ORG}}
      CVE_API_USER: ${{secrets.CVE_API_USER}}
      CVE_API_KEY: ${{secrets.CVE_API_KEY}}
    outputs:
      v_current_run_timestamp: ${{ steps.get-timestamp.outputs.out }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: update log
        # run: echo "out=$(date '+%Y-%m-%d_%H%M_UTC')" >> $GITHUB_OUTPUT
        run: |
          export TEMP_TIMESTAMP=$(date '+%Y-%m-%d_%H%M_UTC')
          echo "out=$TEMP_TIMESTAMP" >> $GITHUB_OUTPUT
          echo $TEMP_TIMESTAMP >> update_log.md
          env
          node ./.github/workflows/dist/index.js
          git add preview_cves
          git commit -m "[UPDATE] updated/added CVEs from cveawg.mitre.org"
          git remote set-url origin https://${GITHUB_TOKEN}@github.com/hkong-mitre/cvelistV5.git
          git config user.email "you@example.com"
          git config user.name "Github Action"
          git add update_log.md
          git commit -m "abc"
          git push

          curl --location --request GET '${{secrets.CVE_API_HOST}}/cve?time_modified.gt=2022-12-10T00:00:00' \
           --header 'CVE-API-ORG: mitre' \
           --header 'CVE-API-USER: ${{secrets.CVE_API_USER}}' \
           --header 'CVE-API-KEY: ${{secrets.CVE_API_KEY}}' \
           --header 'Content-Type: application/json'
          # curl https://raw.githubusercontent.com/CVEProject/cvelist/master/1999/0xxx/CVE-1999-0001.json

      # - name: create release with source code as artifacts
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     name: CVE ${{ needs.generate-name.outputs.v_current_run_timestamp }}
      #     # body: Descriptions for CVE ${{ needs.generate-name.outputs.v_current_run_timestamp }} goes here
      #     body_path: ./release_notes.md
      #     tag_name: cve_${{ needs.generate-name.outputs.v_current_run_timestamp }}
      #     files: |
      #       release_notes.md
      #     #   cves_${{ needs.generate-name.outputs.v_current_run_timestamp }}.zip
